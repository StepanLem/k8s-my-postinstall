---
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes Dashboard
  hosts: kubernetes
  gather_facts: yes
  become: no
  vars:
    dashboard_version: "7.13.0"
    dashboard_values_file: "dashboard-values.yaml"

  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Helm
      command: "helm version"
      register: helm_check
      failed_when: helm_check.rc != 0
      changed_when: false

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Helm —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Kubernetes Dashboard
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes Dashboard
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        chart_version: "{{ dashboard_version }}"
        release_namespace: kubernetes-dashboard
        create_namespace: true
        values_files:
          - "{{ dashboard_values_file }}"

    - name: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Kubernetes Dashboard
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    - name: –°–æ–∑–¥–∞–Ω–∏–µ ServiceAccount –¥–ª—è dashboard
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'dashboard-admin-user.yaml') | from_yaml }}"

    - name: –°–æ–∑–¥–∞–Ω–∏–µ ClusterRoleBinding –¥–ª—è dashboard
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'dashboard-admin-clusterrolebinding.yaml') | from_yaml }}"

    - name: –°–æ–∑–¥–∞–Ω–∏–µ token –¥–ª—è dashboard
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'dashboard-admin-token.yaml') | from_yaml }}"

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ dashboard
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: dashboard-admin-token
        namespace: kubernetes-dashboard
      register: dashboard_token

    - name: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Kubernetes Dashboard
      debug:
        msg: |
          Kubernetes Dashboard —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!
          Namespace: kubernetes-dashboard
          –í–µ—Ä—Å–∏—è: {{ dashboard_version }}
          
          üîó –î–æ—Å—Ç—É–ø –∫ Dashboard:
          - Port-forward: kubectl port-forward -n kubernetes-dashboard service/kubernetes-dashboard 8443:443
          - URL: https://localhost:8443
          
          üîë –¢–æ–∫–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞:
          {{ dashboard_token.resources[0].data.token | b64decode if dashboard_token.resources else '–¢–æ–∫–µ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RBAC' }}
          
          üìã –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç—É–ø–∞:
          - kubectl proxy --port=8001
          - URL: http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
# –í—ã–≤–µ—Å—Ç–∏ bearer —Ç–æ–∫–µ–Ω: 
# kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath="{.data.token}" | base64 -d